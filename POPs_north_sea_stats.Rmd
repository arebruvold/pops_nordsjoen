---
title: "Levels and temporal trends of persistent organic pollutants (POPs) in liver of atlantic cod, haddock and saithe from the northeastern North Sea "
output:
  bookdown::html_document2:
    theme: journal
    code_folding: hide
    number_sections: false
editor_options:
  markdown:
    wrap: 150
always_allow_html: yes

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  echo = TRUE,
  warning = FALSE
)
library(tidyverse)
library(readxl)
library(janitor)
library(broom)
library(scales)
library(visreg)
library(jtools)
library(ggpp)
library(modelr)
library(gt)
library(car)
```


## Data cleaning

```{r}
  raw_data <- read_excel("data/20230424_nordsjoen_stepan.xlsx", skip = 1) %>%
    clean_names() %>% 
      select(species, year, length_cm, fettinnhold_percent, lsi_percent, hel_vekt_g, lever_vekt_g, matches("w_w")) %>%
    drop_na(species, year, length_cm, fettinnhold_percent, lsi_percent) %>% 
  mutate(across(.cols = -species, .fn = ~ as.numeric(.x)))

cleaned_data <- raw_data %>% 
  # log transform response variables and covariate length
    mutate(across(.cols = matches("w_w"), .fn = ~ log10(as.numeric(.x) + 1))) %>%
    mutate(across(.cols = matches("length_cm"), .fn = ~ log10(as.numeric(.x)))) %>%
    mutate(across(.cols = matches("fettinnhold_percent|year|lsi|vekt_g"), .fn = ~ as.numeric(.x))) %>%
    rename_with(
      ~ str_replace_all(.x, c(
        "w_w" = "ww",
        "^s" = "",
        "fettinnhold_percent" = "fat_pc",
        "lsi_percent" = "lsi_pc"
      )) %>%
        str_to_lower(),
      .cols = !matches("species")
    ) %>%
    # remove obs with no POP data
    filter(if_any(matches("ww"), ~ !is.na(.x))) %>%
    pivot_longer(cols = matches("ww"), names_to = "variable", values_to = "value") %>% 
  # update two values found to be incorrectly entered
  mutate(hel_vekt_g = if_else(hel_vekt_g == 635 & lever_vekt_g == 151.9, 6135, hel_vekt_g),
         lsi_pc = if_else(hel_vekt_g == 6135 & lever_vekt_g == 151.9, lever_vekt_g/hel_vekt_g, lsi_pc),
         hel_vekt_g = if_else(hel_vekt_g == 1004 & lever_vekt_g == 780.0, 10040, hel_vekt_g),
         lsi_pc = if_else(hel_vekt_g == 10040 & lever_vekt_g == 780.0, lever_vekt_g/hel_vekt_g, lsi_pc),
         )

```


## Data description

```{r}
cleaned_data %>%
  group_by(species, variable, year) %>%
  summarise(n_obs = n()) %>%
  ungroup() %>%
  select(-variable) %>%
  distinct(species, year, .keep_all = TRUE) %>% pivot_wider(names_from = "species", values_from = "n_obs") %>% 
  gt(
    groupname_col = "species",
    rowname_col = "year"
  )
```


* Observations:
  + Approx. 250 for each fish species (3) for each contaminant (6).
  + For each year at least 41 observations for each species and contaminant except for cod in 2019, with only 9 observations.
* Response variables:
  + Concentrations of six different POPs in liver in ug/kg liver wet weight.
* Explanatory variables:
  + Species 
  + year (must be kept in model)
  + weight of fish (omitted)
  + weight of liver (omitted)
  + length of fish (log transformed for normality)
  + fat percentage (percentage of liver)
  + lsi (liver somatic index: liver weight vs total weight, nutritional condition)
  + fish age (missing variables: omitted)

From previous studies we know the effect of these variables will differ between species due to e.g. different physiology and feeding habits. Hence, including fish as a factor in a single model will require an advanced model and was not justified since comparisons between the levels of the different fish species were not important. Known confounders are fish age or proxies such as fish length and fish weight as well as liver weight, liver at content, hepatosomatic index and liver somatic index.


## Model selection

* Main hypotheses:
  + **Is there a time trend for any of the contaminants in any of the species?**

One identical model was chosen, fitted to each different dataset (3 species x  6 contaminants = 18). This is justified as including an additional explanatory variable should be inconsequential due to the large number of observations. Due to collinearity with lsi and fish length, weight of liver and fish was omitted. Fish age was omitted due to missingness of a substantial fraction of observations and collinearity with fish length. As such, a linear model including explanatory variables year, fish length, fat percentage and lsi was chosen.


## Model fitting

```{r model}
# linear regression model
pop_lm <- function(in_dat) {
  lm(
    data = in_dat, formula = value ~ year + length_cm + fat_pc + lsi_pc,
    na.action = na.exclude
  )
}

```


```{r model-fit-partial}

# conditional partial residuals manually calculated
p_man <- cleaned_data %>%
  ungroup() %>%
  group_by(species, variable) %>%
  drop_na(value) %>%
  nest() %>%
  # apply model and calculate medians of covariates
  mutate(
    model = map(data, pop_lm),
    med_length_cm = map(
      data,
      ~ median(.x$length_cm, na.rm = TRUE)
    ) %>% as.numeric(),
    med_fat_pc = map(
      data,
      ~ median(.x$fat_pc, na.rm = TRUE)
    ) %>% as.numeric(),
        med_lsi_pc = map(
      data,
      ~ median(.x$lsi_pc, na.rm = TRUE)
    ) %>% as.numeric(),
    mean_length_cm = map(
      data,
      ~ mean(.x$length_cm, na.rm = TRUE)
    ) %>% as.numeric(),
    mean_fat_pc = map(
      data,
      ~ mean(.x$fat_pc, na.rm = TRUE)
    ) %>% as.numeric(),
    mean_lsi_pc = map(
      data,
      ~ mean(.x$lsi_pc, na.rm = TRUE)
    ) %>% as.numeric(),
    mean_year = map(
      data,
      ~ mean(.x$year, na.rm = TRUE)
    ) %>% as.numeric(),
    mean_value = map(
      data,
      ~ mean(.x$value, na.rm = TRUE)
    ) %>% as.numeric()
  ) %>%
  mutate(
    glance = map(model, broom::glance),
    year_pval = map(model, ~ broom::tidy(.x)[[2, 5]] %>% as.numeric()),
    # extracting model coefficients for partial residual calculation
    tidy_coeff = map(model, ~ broom::tidy(.x) %>%
      select(term, estimate) %>%
      pivot_wider(names_from = "term", values_from = "estimate") %>%
      clean_names() %>%
      rename_with(.cols = everything(), .fn = ~ paste0(.x, "_coeff"))),
    # tidy gets summary variables of the model coefficients
      tidy = map(model, ~ broom::tidy(.x)),
    # augment gets per observation variables (e.g. residuals)
    augment = map2(model, data, ~ broom::augment(.x, .y)),
    partial_resids = map(model, ~ residuals(.x, type = "partial") %>%
      as_tibble() %>%
      rename_with(.cols = everything(), .fn = ~ paste0(.x, "_partial_resid"))),
    normal_resids = map(model, ~ residuals(.x) %>%
      as_tibble() %>%
      rename_with(.cols = everything(), .fn = ~ paste0(.x, "_normal_resid")))
  ) %>%
  # add package-generated plots for an extra check
  mutate(
    visreg = map(
      model,
      ~ visreg(.x, "year", gg = TRUE, type = "conditional")
    ),
    effect_plot = map(
      model,
      ~ effect_plot(.x, pred = year, interval = TRUE, partial.residuals = TRUE)
    ),
    variable = toupper(variable) %>% str_replace_all("_WW", "")
  ) %>% 
  # vifs to check for collinearity
  mutate(vifs = map(model, ~ car::vif(.x) %>% as_tibble() ))

```

## Model validation

### Linearity

```{r}

#Residuals vs fitted and vs each covriate

p_man %>% unnest(augment) %>%
  ggplot(aes(.fitted, .resid)) +
    geom_point(size = 0.2) + 
    geom_hline(yintercept = 0, color = "red") +
  geom_smooth(method = "loess", formula = y ~ x, se = T, span = 2)+
    facet_grid(species~variable, scales = "free")

```

Some deviation from linearity, especially for HCB in haddock and cod.

```{r}

#Residuals vs each covriate

p_man %>% unnest(augment) %>%
  ggplot(aes(length_cm, .resid)) +
    geom_point(size = 0.2) + 
      geom_hline(yintercept = 0, color = "red") +
  geom_smooth(method = "loess", formula = y ~ x, se = T, span = 2)+
    facet_grid(species~variable, scales = "free")

p_man %>% unnest(augment) %>%
  ggplot(aes(fat_pc, .resid)) +
    geom_point(size = 0.2) + 
      geom_hline(yintercept = 0, color = "red") +
  geom_smooth(method = "loess", formula = y ~ x, se = T, span = 2)+
    facet_grid(species~variable, scales = "free")

p_man %>% unnest(augment) %>%
  ggplot(aes(lsi_pc, .resid)) +
    geom_point(size = 0.2) + 
    geom_hline(yintercept = 0, color = "red") +
  geom_smooth(method = "loess", formula = y ~ x, se = T, span = 2)+
    facet_grid(species~variable, scales = "free")


```



### Normality

#### QQ-plot of response

```{r}
ggplot(p_man %>% unnest(augment), aes(sample = value)) +
  stat_qq(size = 0.2) +
  stat_qq_line(color = "red", size = 0.4) +
  facet_grid(species ~ variable, scales = "free")
```

#### Distribution of response

```{r}
ggplot(p_man %>% unnest(augment), aes(value)) +
    geom_histogram(aes(y=..density..), color='gray50',
        alpha=0.2, position = "identity")+
    geom_density(alpha=0.2, fill = "red")+
  facet_grid(species ~ variable, scales = "free")
```


#### Shapiro-Wilk's test


```{r shapiro-3col}
shap_table <- p_man %>% unnest(augment) %>% group_by(species, variable) %>% summarise(shapiro = shapiro.test(.std.resid) %>% tidy()) %>% unnest(shapiro) %>% select(-method, -statistic)

fish_table <- function(x){
  gt(x) %>% 
    tab_style(
    location = cells_body(
      columns = p.value,
      rows = p.value < 0.05
    ),
    style = list(cell_text(color = "red"))
  ) %>% fmt_number(columns = 2, decimals = 3) %>% 
    tab_options(column_labels.hidden = TRUE) %>% 
    as_raw_html() # return as html
}

left_table <- 
  shap_table %>% 
  filter(species == "Cod") %>% 
  ungroup() %>% 
  select(-species) %>% 
  fish_table()

mid_table <- 
  shap_table %>% 
  filter(species == "Haddock") %>%
    ungroup() %>% 
  select(-species) %>% 
  fish_table()

right_table <- 
  shap_table %>% 
  filter(species == "Saithe") %>%
    ungroup() %>% 
  select(-species) %>% 
  fish_table()

data_tables <- data.frame(left_table = left_table,
                          mid_table = mid_table,
                          right_table = right_table)

data_tables %>% 
  gt() %>% 
  fmt_markdown(columns = TRUE) %>% #render cell contents as html
  cols_label(left_table = "Cod",
             mid_table = "Haddock",
             right_table = "Saithe") %>% 
  tab_footnote("Red text indicates p-value < 0.05.")

```

Deviation from normality is observed and p-values should be interpreted with caution.

### Homoskedasticity

#### Scale-location plot

```{r}
p_man %>%
  unnest(augment) %>%
  ggplot(aes(x = .fitted, y = sqrt(abs(.std.resid)))) +
  geom_point(size = 0.2) +
  geom_smooth(method = "loess", formula = y ~ x, span = 2, se = T, size = 0.5) +
  geom_smooth(method = "lm", formula = y ~ 1, se = FALSE, color = "red", size = 0.5, linetype="dashed", span = 2)+
  facet_grid(species ~ variable, scales = "free")
```


### Multicollinearity

VIFs were determined to be below 3 for each dependent variable.

```{r}
cleaned_data %>%
  select(-variable, -value, -hel_vekt_g, -lever_vekt_g) %>%
  mutate(across(!matches("species"), ~ as.numeric(.x))) %>%
  pivot_longer(cols = -c("species", "year"), names_to = "variable", values_to = "value") %>%
  ggplot(aes(as_factor(year), value)) +
  geom_point() + geom_boxplot()+
  theme(
      axis.text.x = element_text(angle = 90, hjust = 1)
    )+
  ggh4x::facet_grid2(species ~ variable, scales = "free_y", independent = "y")
```

However, we appear to have a decrease in LSI for haddock with year due to fish weight/size increase.

### Outliers

```{r}
cleaned_data %>%
  select(-variable, -value) %>%
  mutate(across(!matches("species"), ~ as.numeric(.x))) %>%
  pivot_longer(cols = -"species", names_to = "variable", values_to = "value") %>%
  ggplot(aes(value)) +
  geom_histogram(bins = 50) +
  facet_grid(species ~ variable, scales = "free")+ theme(
      axis.text.x = element_text(angle = 90, hjust = 1)
    )

cleaned_data %>%
  select(-variable, -value) %>%
  mutate(across(!matches("species"), ~ as.numeric(.x))) %>%
  pivot_longer(cols = -"species", names_to = "variable", values_to = "value") %>%
  ggplot(aes(value)) + geom_boxplot() + facet_grid(species ~ variable, scales = "free")+ theme(
      axis.text.x = element_text(angle = 90, hjust = 1)
    )
```
Two outliers were identified in LSI. Upon further investigation, it was determined that these values were the result of typographic errors during data collection. These errors were corrected during the data cleaning above.

## Partial residuals

### Background

Assuming the least square estimate of the covariates $X_{1}$, $X_{2}$ and $X_{3}$ and $y_i$ and $\epsilon_i$ is the response and residual for the i-th point:

$$
y_i = f_1(x_{i1}) + f_2(x_{i2}) + f_3(x_{i3}) + \epsilon_i.
$$

The partial residual of $X_3$ for the i-th observation is then generally defined as (Sohil et al., 2021) (Larsen and McCleary, 1972):

$$
r_i = y_i-f_1\left(x_{i 1}\right)-f_2\left(x_{i 2}\right) = \epsilon_i + f_3(x_{i3}) ,
$$
 
 where in the present case


$$
y_i = \hat b_0 + \hat b_{year}(year_{i})+ \hat b_{length}(length_{i})+\hat b_{fat pc}(fatpc_{i})+ \hat b_{lsi pc}(lsi pc_{i})+ \epsilon_i
$$
or, similarly

$$
 y_i = \bar y + \hat b_{year}\cdot (x_{year}-\bar x_{year}) + \hat b_{length}\cdot (x_{length}-\bar x_{length}) + \hat b_{fatpc}\cdot (x_{fatpc}-\bar x_{fatpc})  + \hat b_{lsipc}\cdot (x_{lsipc}-\bar x_{lsipc}) + \epsilon_i
$$

### Conditional partial residual plots

```{r}
p_man %>%
  unnest(tidy_coeff, partial_resids, data, normal_resids, augment) %>%
  ungroup() %>%
  ggplot(aes(year, (value_normal_resid + year * year_coeff + intercept_coeff + med_length_cm * length_cm_coeff + med_fat_pc * fat_pc_coeff + med_lsi_pc * lsi_pc_coeff))) +
  geom_jitter(size = 0.2, na.rm = T, height = 0, width = 0.2) +
  # geom_point(aes(year, value), size = 0.2, color = "darkgrey", position = position_jitternudge(width = 0.2, height = 0,
  #                                    seed = 123, x = 0.5,
  #                                    direction = "as.is",
  #                                    nudge.from = "jittered"))+
  ### TEST COND PART RESID
  # geom_point(aes(year, value_normal_resid + mean_value +
  #                year_coeff*(year - mean_year) + length_cm_coeff*(med_length_cm - mean_length_cm) + fat_pc_coeff*(med_fat_pc - mean_fat_pc)), size = 0.2, color = "orange", position = position_jitternudge(width = 0.2, height = 0,
  #                                    seed = 123, x = -0.5,
  #                                    direction = "as.is",
  #                                    nudge.from = "jittered"))+
  ### TEST COND PART RESID END
  stat_smooth(method = "lm", na.rm = TRUE, se = TRUE, color = "red", size = 0.5) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.key = element_blank(),
    strip.background = element_rect(colour="black", fill="white"),
    strip.text.x = element_text(face = "bold"),
    strip.text.y = element_text(face = "bold")
  ) +
  geom_text(
    data = p_man %>% group_by(species, variable) %>%
      distinct(year_pval, .keep_all = TRUE), color = "black",
    x = -Inf, y = Inf, hjust = -0.075, vjust = 1.5, size = 3,
    aes(label = paste0("p = ", round(year_pval %>% as.numeric(), digits = 3) %>% format(nsmall = 3)))
  ) +
  #   geom_text(
  #   data = p_man %>% unnest(tidy) %>% group_by(species, variable) %>%
  #     distinct(year_coeff, .keep_all = TRUE), color = "red",
  #   x = -Inf, y = Inf, hjust = -0.1, vjust = 3, size = 2.5,
  #   aes(label = paste0("slope = ", round(year_coeff %>% as.numeric(), digits = 4)))
  # ) +
  scale_x_continuous(breaks = c(2019, 2016, 2013, 2011, 2008, 2005, 2010)) +
  scale_y_continuous(breaks = c(0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4)) +
  ylab("log(Concentration + 1) [\u00b5g/kg]") +
  xlab("Year | (Length, Fat and LSI)") +

    facet_grid(species ~ factor(variable, levels = c(
    "PCB7",
    "DDT",
    "HCH",
    "HCB",
    "TNC",
    "PBDE"
  )))

ggsave("conditional_pr_stepan_data.png", width = 13, height = 7)

# comditional jtools and visreg
# p_man$visreg[[18]] + scale_y_continuous(breaks = pretty_breaks(n = 10))
# p_man$effect_plot[[18]]
# patchwork::wrap_plots(p_man$visreg)
```

## Strength of decrease

```{r}

p_man %>% clean_names() %>%
  select(species, variable, tidy) %>%
  unnest(tidy) %>%
  filter(term == "year") %>%
  select(species, variable, p.value, estimate) %>%
  mutate(estimate = 10^estimate - 1) %>%
  gt(groupname_col = "variable",
     rowname_col = "species") %>% 
  tab_style(
    location = cells_body(
      columns = estimate,
      rows = estimate > 0 & p.value < 0.05
    ),
    style = list(cell_text(color = "red"))
  ) %>% 
  
    tab_style(
    location = cells_body(
      columns = estimate,
      rows = estimate < 0 & p.value < 0.05
    ),
    style = list(cell_text(color = "green"))
  ) %>% 
  fmt_number(everything(), decimals = 3) %>% 
  fmt_percent(estimate, decimals = 1) %>% 
  tab_footnote("Estimated annual percentage change obtained by exponentiation and corresponding p-values. Green color represents a significant decrease at the p = 0.05 level, while red color indicates a significant increase.")

```



## Method description

Statistical analyses were carried out in R version 4.2.1. Data with missing covariates or response variables were removed, and response variables were added one prior to logtransformation with base 10 to meet assumptions of homoscedasticity and normality while preserving zero-valued observations. The covariate length was also logtransformed. To correct for known confounders, a multiple linear regression model with the covariates year, length, fat percentage and liver somatic index was fitted to the cleaned and transformed data for each POP and species. To visually demonstrate the effect of year on the POP concentrations correcting for other dependent variables, the conditional partial residuals versus year was plotted, keeping length, fat and lsi constant at their median values. The significance of the regression coefficient for the year was determined using a Wald test to test the null hypothesis of no time trend. As detailed in the supplementary material (XXX), model validation revealed some deviation from model assumptions. As such, marginal effects were interpreted with caution.


## References

* Sohil, F., Sohali, M.U., Shabbir, J., 2021. An introduction to statistical learning with applications in R: by Gareth James, Daniela Witten, Trevor Hastie, and Robert Tibshirani, New York, Springer Science and Business Media, 2013, $41.98, eISBN: 978-1-4614-7137-7. Statistical Theory and Related Fields 1–1. https://doi.org/10.1080/24754269.2021.1980261

* Larsen, W.A., McCleary, S.J., 1972. The Use of Partial Residual Plots in Regression Analysis. Technometrics 14, 781–790. https://doi.org/10/gp2cxn
