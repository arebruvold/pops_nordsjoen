---
title: "Data POPs i fiskelever fra Nordsjøen"
author: "Are"
date: "2023-04-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(janitor)
library(broom)
library(scales)
library(visreg)
library(jtools)
library(ggpp)
```


## Background literature

Se: [@dunn_generalized_2018] p102 og [@sohil_introduction_2021][@moya-larano_plotting_2008]. "Partial residual plots could be used if the only purpose is to show how Y changes within the range of observed X values", and the slope of the fitted line corresponds to the regression coefficient in the complete model [@moya-larano_plotting_2008].

Alternativt og kanskje bedre: Gjøre Mann-Kendall test på residualer fra modell som korrigerer for lengde og fettinnhold. Plotte partielle residualer for GAM-modell. Da bruke nøyaktig samplingtid og gjøre MK-test plus avplot(?)
https://www.sciencedirect.com/science/article/pii/S1364815220310069
https://www.epa.gov/sites/default/files/2016-05/documents/tech_notes_6_dec2013_trend.pdf
Statistical Methods for Trend Detection and Analysis in the Environmental Sciences
https://cran.r-project.org/web/packages/trend/vignettes/trend.pdf

## Data cleaning

```{r}
# exported .xlsx to .csv from the file received from Sylvia on mail 14/4/23 using Excel.
raw_data <- read_csv2("data/Hele datasettet lipidvekt til Sylvia med fys param sfr.csv") %>%
  clean_names() %>% mutate(log_hel_lengde_cm = log10(hel_lengde_cm)) %>% 
  drop_na(log_hel_lengde_cm, fettinnhold_percent) %>%    select(year, species, log_hel_lengde_cm, fettinnhold_percent, matches("log.+ww")) %>%
  # remove obs with no pop data
  filter(if_any(matches("log.+ww"), ~ !is.na(.x))) %>%
    pivot_longer(cols = matches("log.+ww"), names_to = "variable", values_to = "value")
# aligned top columns and added species column in excel.
# raw_data <-
  
  raw_data <- read_excel("data/20230424_nordsjoen_stepan.xlsx", skip = 1) %>%
    clean_names() %>%
    select(species, year, length_cm, fettinnhold_percent, matches("w_w")) %>%
    drop_na(species, year, length_cm, fettinnhold_percent) %>%
    mutate(across(.cols = matches("w_w|length_cm"), .fn = ~ as.numeric(.x) %>% log10())) %>%
    rename_with(
      ~ str_replace_all(.x, c(
        "w_w" = "ww",
        "^s" = "",
        "fettinnhold_percent" = "fat_pc"
      )) %>%
        str_to_lower(),
      .cols = !matches("species")
    ) %>%
    # remove obs with no pop data
    filter(if_any(matches("ww"), ~ !is.na(.x))) %>%
    pivot_longer(cols = matches("ww"), names_to = "variable", values_to = "value")
  
```




## Partial residual plot

Assuming the least square estimate of the covariates $X_{1}$, $X_{2}$ and $X_{3}$ and $y_i$ and $\epsilon_i$ is the response and residual for the i-th point:

$$
y_i = f_1(x_{i1}) + f_2(x_{i2}) + f_3(x_{i3}) + \epsilon_i.
$$

The partial residual of $X_3$ for the i-th observation is then generally defined as [@sohil_introduction_2021][@larsen_use_1972]:

$$
r_i = y_i-f_1\left(x_{i 1}\right)-f_2\left(x_{i 2}\right) = \epsilon_i + f_3(x_{i3}) ,
$$


It must be emphasized that where $f_{n}$ in the simplest linear case corresponds to 

$$
f_n = b_n\cdot (x_n-\bar x_n),
$$
and *not* $f_n = b_n\cdot x_n$!

$$
y_i = \hat b_0 + \hat b_{year}(year_{i})+ \hat b_{length}(length_{i})+\hat b_{fatperc}(fatperc_{i})+ \epsilon_i
$$
or, similarly (VERIFY)

$$
 y_i = \hat b_{year}\cdot (x_{year}-\bar x_{year}) + \hat b_{length}\cdot (x_{length}-\bar x_{length}) + \hat b_{fatperc}\cdot (x_{fatperc}-\bar x_{fatperc}) 
$$
## Added-variable or partial regression plot TODO, outdated cleaning

See: https://stackoverflow.com/questions/59150905/is-there-a-ggplot2-analogue-to-the-avplots-function-in-r , https://bookdown.org/rwnahhas/RMPH/mlr-viz-adj.html
```{r}
# jtools::effect_plot(pop_lever)


yz_lm <- function(df) {
    lm(data = df, formula = value ~  hel_lengde_cm + fettinnhold_percent, na.action = na.exclude)
}

xz_lm <- function(df) {
    lm(data = df, formula = year ~  hel_lengde_cm + fettinnhold_percent, na.action = na.exclude)
}

# exported .xlsx to .csv from the file received from Sylvia on mail 14/4/23 using Excel.
# cleaning, removing unused variables
pop_lever_added_var <- read_csv2("data/Hele datasettet lipidvekt til Sylvia med fys param sfr.csv") %>%
  clean_names() %>%
  select(year, area, species, hel_lengde_cm, fettinnhold_percent, matches("log.+ww")) %>%
  filter(if_any(matches("log"), ~ !is.na(.x))) %>%
  # pivoting to tidy data
  pivot_longer(cols = matches("log.+ww"), names_to = "variable", values_to = "value") %>%
  mutate(
    year = as.integer(year)
  ) %>%
  # gjøre tidy
  group_by(species, variable) %>%
  nest() %>%
  mutate(yz_model = map(data, yz_lm)) %>%
  mutate(xz_model = map(data, xz_lm)) %>%
  # glance gets the model summary variables
  mutate(
    # glance = map(model, broom::glance),
    # # tidy gets summary variables of the model coefficients
    # tidy = map(model, broom::tidy),
    # augment gets per observation variables (e.g., residuals)
    # augment = map2(model, data, ~ broom::augment(.x, .y)),
    yz_resids = map2(yz_model, data, ~ (residuals(.x) + 
                                          mean(.y$value, na.rm = TRUE) +
                                          0
                                        ) %>%
      as_tibble() %>%
      rename_with(.cols = everything(), .fn = ~ paste0(.x, "_yz_resids"))),
     xz_resids = map2(xz_model, data, ~ (residuals(.x) + mean(.y$year)) %>%
      as_tibble() %>%
      rename_with(.cols = everything(), .fn = ~ paste0(.x, "_xz_resids"))),
  ) %>% unnest(data, yz_resids , xz_resids)

pop_lever_added_var %>% 
  ggplot(aes(value_xz_resids, value_yz_resids)) +
  geom_jitter(size = 0.2) +
  facet_grid(species ~ variable, scales = "free") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
  ) +
  scale_x_continuous(breaks = pretty_breaks())+ylab("pop_lever_added_var")

# scatterplot
pop_lever_added_var %>% 
  ggplot(aes(year, value )) +
  geom_jitter(size = 0.2) +
  facet_grid(species ~ variable, scales = "free") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
  ) +
  scale_x_continuous(breaks = pretty_breaks())+ylab("scatter")

```




## Conditional partial residual plots

```{r}
# full linear regression model
pop_lm <- function(in_dat) {
  lm(
    data = in_dat, formula = value ~ year + log_hel_lengde_cm + fettinnhold_percent,
    na.action = na.exclude
  )
}

# conditional manual
p_man <- raw_data %>%
  ungroup() %>%
  group_by(species, variable) %>%
  nest() %>%
  # apply model and calculate medians of covariates
  mutate(
    model = map(data, pop_lm),
    med_log_hel_lengde_cm = map(
      data,
      ~ median(.x$log_hel_lengde_cm, na.rm = TRUE)
    ) %>% as.numeric(),
    med_fettinnhold_percent = map(
      data,
      ~ median(.x$fettinnhold_percent, na.rm = TRUE)
    ) %>% as.numeric(),
    mean_log_hel_lengde_cm = map(
      data,
      ~ mean(.x$log_hel_lengde_cm, na.rm = TRUE)
    ) %>% as.numeric(),
    mean_fettinnhold_percent = map(
      data,
      ~ mean(.x$fettinnhold_percent, na.rm = TRUE)
    ) %>% as.numeric(),
    mean_year = map(
      data,
      ~ mean(.x$year, na.rm = TRUE)
    ) %>% as.numeric()
  ) %>%
  mutate(
    glance = map(model, broom::glance),
    year_pval = map(model, ~ broom::tidy(.x)[[2, 5]] %>% as.numeric()),
    # tidy gets summary variables of the model coefficients, pivot to get coeffs for unnest
    tidy = map(model, ~ broom::tidy(.x) %>%
      select(term, estimate) %>%
      pivot_wider(names_from = "term", values_from = "estimate") %>%
      clean_names() %>%
      rename_with(.cols = everything(), .fn = ~ paste0(.x, "_coeff"))),
    # augment gets per observation variables (e.g., residuals)
    augment = map2(model, data, ~ broom::augment(.x, .y)),
    partial_resids = map(model, ~ residuals(.x, type = "partial") %>%
      as_tibble() %>%
      rename_with(.cols = everything(), .fn = ~ paste0(.x, "_partial_resid"))),
    normal_resids = map(model, ~ residuals(.x) %>%
      as_tibble() %>%
      rename_with(.cols = everything(), .fn = ~ paste0(.x, "_normal_resid")))
  ) %>%
  # add package-generated plots for an extra check
  mutate(
    visreg = map(
      model,
      ~ visreg(.x, "year", gg = TRUE, type = "conditional")
    ),
    effect_plot = map(
      model,
      ~ effect_plot(.x, pred = year, interval = TRUE, partial.residuals = TRUE)
    )
  )


p_man %>%
  unnest(tidy, partial_resids, data, normal_resids, augment) %>%
  ungroup() %>%
  ggplot(aes(year, (value_normal_resid + year * year_coeff + intercept_coeff + med_log_hel_lengde_cm * log_hel_lengde_cm_coeff + med_fettinnhold_percent * fettinnhold_percent_coeff))) +
  geom_jitter(size = 0.2, na.rm = T, height = 0, width = 0.2) +
  geom_point(aes(year, value), size = 0.2, color = "green", position = position_jitternudge(width = 0.2, height = 0,
                                     seed = 123, x = 0.5,
                                     direction = "as.is",
                                     nudge.from = "jittered"))+
  stat_smooth(method = "lm", na.rm = TRUE, se = TRUE, color = "red", size = 0.5) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.key = element_blank(), strip.background = element_rect(colour="black", fill="white")
  ) +
  geom_text(
    data = p_man %>% group_by(species, variable) %>%
      distinct(year_pval, .keep_all = TRUE), color = "red",
    x = -Inf, y = -Inf, hjust = -0.05, vjust = -0.5, size = 2.5,
    aes(label = paste("p-val:", round(year_pval %>% as.numeric(), digits = 6)))
  ) +
  scale_x_continuous(breaks = c(2019, 2016, 2013, 2011, 2008, 2005, 2010)) +
  scale_y_continuous(breaks = pretty_breaks(n = 10)) +
  ylab("Concentration [log(mg/kg)]") +
  xlab("Year") +
  facet_grid(species ~ factor(variable, levels = c(
    "log_pcb7_ww",
    "log_ddt_ww",
    "log_hch_ww",
    "log_hcb_ww",
    "log_tnc_ww",
    "log_pbde_ww"
  )))

ggsave("conditional_pr_sylvia_data.png")

# comditional jtools and visreg
p_man$visreg[[18]] + scale_y_continuous(breaks = pretty_breaks(n = 10))
p_man$effect_plot[[18]]
# patchwork::wrap_plots(p_man$visreg)
```

## Normal

```{r}
p_man %>%
  unnest(tidy, partial_resids, data, normal_resids, augment) %>%
  ungroup() %>%
  ggplot(aes(year, year_partial_resid)) +
  geom_jitter(size = 0.2, na.rm = T, height = 0, width = 0.2) +
  stat_smooth(method = "lm", na.rm = TRUE, se = TRUE, color = "red", size = 0.5) +
    theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1),
    legend.key = element_blank(), strip.background = element_rect(colour="black", fill="white")
  ) +
  geom_text(
    data = p_man %>% group_by(species, variable) %>%
      distinct(year_pval, .keep_all = TRUE), color = "red",
    x = -Inf, y = -Inf, hjust = -0.05, vjust = -0.5, size = 2.5,
    aes(label = paste("p-val:", round(year_pval %>% as.numeric(), digits = 6)))
  ) +
  scale_x_continuous(breaks = c(2019, 2016, 2013, 2011, 2008, 2005, 2010)) +
  scale_y_continuous(breaks = pretty_breaks(n = 10)) +
  ylab("Concentration [log(mg/kg)]") +
  xlab("Year") +
  facet_grid(species ~ factor(variable, levels = c(
    "log_pcb7_ww",
    "log_ddt_ww",
    "log_hch_ww",
    "log_hcb_ww",
    "log_tnc_ww",
    "log_pbde_ww"
  )))
 

p_man %>% unnest(tidy, partial_resids, data, normal_resids, augment) %>% group_by(variable, species) %>%
  summarise(median_presid = mean(year_partial_resid, na.rm = TRUE))
```

## Partial residual test

```{r}
p_man %>% unnest(normal_resids, tidy, data, partial_resids) %>% 
  mutate(
    partial_resids_man = value_normal_resid  + year_coeff * (year - mean_year)
  ) %>% View()
  

```


