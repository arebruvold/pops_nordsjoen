---
title: "Data POPs i fiskelever fra Nordsjøen"
author: "Are"
date: "2023-04-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(janitor)
library(broom)
library(scales)
library(visreg)
```

## Todo

Cleanup such that datacleaning on top.
Check with termplot that we get the same.
Add regression tables?
Convert into conditional component plus residual plot as per visreg  [@breheny_visualization_2017] Visreg uses median of each variable.


## Background/theory

Se: [@dunn_generalized_2018]p102 og [@sohil_introduction_2021][@moya-larano_plotting_2008]. "Partial residual plots could be used if the only purpose is to show how Y changes within the range of observed X values", and the slope of the fitted line corresponds to the regression coefficient in the complete model [@moya-larano_plotting_2008].

Alternativt og kanskje bedre: Gjøre Mann-Kendall test på residualer fra modell som korrigerer for lengde og fettinnhold. Plotte partielle residualer for GAM-modell:
https://www.sciencedirect.com/science/article/pii/S1364815220310069
https://www.epa.gov/sites/default/files/2016-05/documents/tech_notes_6_dec2013_trend.pdf
Statistical Methods for Trend Detection and Analysis in the Environmental Sciences
https://cran.r-project.org/web/packages/trend/vignettes/trend.pdf
Alternativt bruke nøyaktig samplingtid og gjøre MK-test plus avplot?

## Data cleaning

```{r}
# exported .xlsx to .csv from the file received from Sylvia on mail 14/4/23 using Excel.
raw_data <- read_csv2("data/Hele datasettet lipidvekt til Sylvia med fys param sfr.csv") %>%
  clean_names() %>% mutate(log_hel_lengde_cm = log10(hel_lengde_cm))
  
```




## Partial residual plot

The partial residual of $X_3$ for the i-th observation is generally defined as [@sohil_introduction_2021][@moya-larano_plotting_2008]:

$$
r_i=y_i-\beta_0-f_1\left(x_{i 1}\right)-f_2\left(x_{i 2}\right),
$$

**SHOULD NOT INTERCEPT BE INCLUDED ($\beta_0$)? MAIL SENT TO statlearning!**

or, (almost) equivalently,

$$
r_i = \epsilon_i + f_3(x_{i3})
$$

where $f_1$ and $f_2$ in the simplest linear case corresponds to $\hat\beta_1X_{i1}$ and $\hat\beta_2X_{i2}$, and where $\epsilon_i$ is the residual from the overall model $y_i = \beta_0 + f_1\left(x_{i 1}\right)+f_2\left(x_{i 2}\right)+f_3\left(x_{i 3}\right)$


$$
r_i = \epsilon_i + \hat\beta_3(year_{i})
$$

$$
y_i = \hat\beta_0 + \hat\beta_{year}(year_{i})+ \hat\beta_{length}(length_{i})+\hat\beta_{fatperc}(fatperc_{i})+ \epsilon_i
$$


```{r}

# make tidy, value and parameter

# full linear regression model
pop_lm <- function(in_dat) {
    lm(data = in_dat, formula = value ~ year + log_hel_lengde_cm + fettinnhold_percent, na.action = na.exclude)
}


# cleaning, removing unused variables
pop_lever <- raw_data %>% 
  select(year, area, species, log_hel_lengde_cm, fettinnhold_percent, matches("log.+ww")) %>%
  filter(if_any(matches("log.+ww"), ~ !is.na(.x))) %>%
  # pivoting to tidy data
  pivot_longer(cols = matches("log.+ww"), names_to = "variable", values_to = "value") %>%
  mutate(
    year = as.integer(year)
  ) %>%
  # gjøre tidy
  group_by(species, variable) %>%
  nest() %>%
  mutate(model = map(data, pop_lm)) %>%
  # glance gets the model summary variables
  mutate(
    glance = map(model, broom::glance),
    # tidy gets summary variables of the model coefficients
    tidy = map(model, broom::tidy),
    # augment gets per observation variables (e.g., residuals)
    augment = map2(model, data, ~ broom::augment(.x, .y)),
    partial_resids = map(model, ~ residuals(.x, type = "partial") %>%
      as_tibble() %>%
      rename_with(.cols = everything(), .fn = ~ paste0(.x, "_partial_resid")))
  ) %>% #mutate(plot = map(model, ~ visreg(.x, gg=TRUE)))
  unnest(data, partial_resids)




pop_lever %>% 
  mutate(year_pval = map(tidy, ~ .x[[2,5]]) %>% as.numeric()) %>%
    ggplot(aes(year, year_partial_resid)) +
  geom_jitter(size = 0.2) +
    geom_smooth(method = "lm", se = TRUE, color = "red", size = 0.5)+
  facet_grid(species ~ variable, scales = "free") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
  ) +
  # geom_text(color = "red",
  #     x = -Inf, y = -Inf, hjust = -0.05, vjust = -0.5, size = 2.5,
  #     aes(label = paste("adj. R2:", round(adj.r.squared, digits = 3)))
  #   ) +
    geom_text(color = "red",
      x = -Inf, y = -Inf, hjust = -0.05, vjust = -0.5, size = 2.5,
      aes(label = paste("p-val:", round(year_pval, digits = 6)))
    )+
  scale_x_continuous(breaks = pretty_breaks())+ylab("P-resids")

ggsave("test.png")

# test2 <- lm(data = read_csv2("data/Hele datasettet lipidvekt til Sylvia med fys param sfr.csv") %>%
#   clean_names() %>%
#   select(year, area, species, hel_lengde_cm, fettinnhold_percent, matches("log.+ww")) %>%
#   drop_na() %>%
#   # pivoting to tidy data
#   pivot_longer(cols = matches("log.+ww"), names_to = "variable", values_to = "value") %>%
#   mutate(
#     year = as.integer(year)
#   ) %>% filter(variable == "log_pbde_ww", area == "Egersund Bank", species == "Saithe") , formula = value ~ year + hel_lengde_cm + fettinnhold_percent)
# 
# termplot( test2, partial.resid=TRUE, terms="year", las=1)

```
## Added-variable or partial regression plot TODO, outdated cleaning

See: https://stackoverflow.com/questions/59150905/is-there-a-ggplot2-analogue-to-the-avplots-function-in-r , https://bookdown.org/rwnahhas/RMPH/mlr-viz-adj.html
```{r}
# jtools::effect_plot(pop_lever)


yz_lm <- function(df) {
    lm(data = df, formula = value ~  hel_lengde_cm + fettinnhold_percent, na.action = na.exclude)
}

xz_lm <- function(df) {
    lm(data = df, formula = year ~  hel_lengde_cm + fettinnhold_percent, na.action = na.exclude)
}

# exported .xlsx to .csv from the file received from Sylvia on mail 14/4/23 using Excel.
# cleaning, removing unused variables
pop_lever_added_var <- read_csv2("data/Hele datasettet lipidvekt til Sylvia med fys param sfr.csv") %>%
  clean_names() %>%
  select(year, area, species, hel_lengde_cm, fettinnhold_percent, matches("log.+ww")) %>%
  filter(if_any(matches("log"), ~ !is.na(.x))) %>%
  # pivoting to tidy data
  pivot_longer(cols = matches("log.+ww"), names_to = "variable", values_to = "value") %>%
  mutate(
    year = as.integer(year)
  ) %>%
  # gjøre tidy
  group_by(species, variable) %>%
  nest() %>%
  mutate(yz_model = map(data, yz_lm)) %>%
  mutate(xz_model = map(data, xz_lm)) %>%
  # glance gets the model summary variables
  mutate(
    # glance = map(model, broom::glance),
    # # tidy gets summary variables of the model coefficients
    # tidy = map(model, broom::tidy),
    # augment gets per observation variables (e.g., residuals)
    # augment = map2(model, data, ~ broom::augment(.x, .y)),
    yz_resids = map2(yz_model, data, ~ (residuals(.x) + 
                                          mean(.y$value, na.rm = TRUE) +
                                          0
                                        ) %>%
      as_tibble() %>%
      rename_with(.cols = everything(), .fn = ~ paste0(.x, "_yz_resids"))),
     xz_resids = map2(xz_model, data, ~ (residuals(.x) + mean(.y$year)) %>%
      as_tibble() %>%
      rename_with(.cols = everything(), .fn = ~ paste0(.x, "_xz_resids"))),
  ) %>% unnest(data, yz_resids , xz_resids)

pop_lever_added_var %>% 
  ggplot(aes(value_xz_resids, value_yz_resids)) +
  geom_jitter(size = 0.2) +
  facet_grid(species ~ variable, scales = "free") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
  ) +
  scale_x_continuous(breaks = pretty_breaks())+ylab("pop_lever_added_var")

pop_lever_added_var %>% 
  ggplot(aes(year, value )) +
  geom_jitter(size = 0.2) +
  facet_grid(species ~ variable, scales = "free") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
  ) +
  scale_x_continuous(breaks = pretty_breaks())+ylab("pop_lever_added_var")

```



## Modeling from scratch

```{r}


# candidate regression model
test_lm <- function(df) {
    lm(data = df, formula = value ~ year + hel_lengde_cm + fettinnhold_percent, na.action = na.exclude)
}

mod_test <- raw_data %>%
  
  select(species, area, year, hel_lengde_cm, fettinnhold_percent, pcb7_mg_kg_ww, ddt_ww1, hch_ww, tnc_ww, hcb_ww, pbde_ww) %>%
  mutate(across(.cols = matches("_ww"), log10, .names = "log_{col}"), .keep = "unused") %>%
  filter(if_any(matches("ww"), ~ !is.na(.x))) %>%
  pivot_longer(cols = matches("ww"), names_to = "variable", values_to = "value") %>% drop_na(species) %>%
  group_by(species, variable) %>% 
  nest() %>% 
  mutate(model = map(data, test_lm)) %>%
  # glance gets the model summary variables
  mutate(
    glance = map(model, broom::glance),
    # tidy gets summary variables of the model coefficients
    tidy = map(model, broom::tidy),
    # augment gets per observation variables (e.g., residuals)
    augment = map2(model, data, ~ broom::augment(.x, .y)))
  
  
```

